<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Spring StateMachine介绍 | Sunbufu's blog</title><meta name=keywords content="Spring,StateMachine"><meta name=description content="Spring StateMachine介绍"><meta name=author content="sunbufu"><link rel=canonical href=https://sunbufu.vercel.app/posts/2018-and-before/2018-06-13-spring-statemachine/><link crossorigin=anonymous href=/assets/css/stylesheet.min.2d6dbfc6e0f8a1db1c9d082a76dc11d094328cf63f247bbc2421dfaa7f2bb170.css integrity="sha256-LW2/xuD4odscnQgqdtwR0JQyjPY/JHu8JCHfqn8rsXA=" rel="preload stylesheet" as=style><link rel=preload href=icon/favicon-152x152.png as=image><script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://sunbufu.vercel.app/icon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://sunbufu.vercel.app/icon/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://sunbufu.vercel.app/icon/favicon-32x32.png><link rel=apple-touch-icon href=https://sunbufu.vercel.app/icon/apple-touch-icon.png><link rel=mask-icon href=https://sunbufu.vercel.app/icon/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.83.1"><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-123-45','auto'),ga('send','pageview'))</script><meta property="og:title" content="Spring StateMachine介绍"><meta property="og:description" content="Spring StateMachine介绍"><meta property="og:type" content="article"><meta property="og:url" content="https://sunbufu.vercel.app/posts/2018-and-before/2018-06-13-spring-statemachine/"><meta property="og:image" content="https://sunbufu.vercel.app/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2018-06-13T00:00:00+00:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://sunbufu.vercel.app/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Spring StateMachine介绍"><meta name=twitter:description content="Spring StateMachine介绍"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://sunbufu.vercel.app/posts/"},{"@type":"ListItem","position":2,"name":"Spring StateMachine介绍","item":"https://sunbufu.vercel.app/posts/2018-and-before/2018-06-13-spring-statemachine/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring StateMachine介绍","name":"Spring StateMachine介绍","description":"Spring StateMachine介绍","keywords":["Spring","StateMachine"],"articleBody":"一、状态机 有限状态机是一种用来进行对象行为建模的工具，其作用主要是描述对象在它的生命周期内所经历的状态序列，以及如何响应来自外界的各种事件。在电商场景（订单、物流、售后）、社交（IM消息投递）、分布式集群管理（分布式计算平台任务编排）等场景都有大规模的使用。\n状态机的要素： 状态机可归纳为4个要素，现态、条件、动作、次态。“现态”和“条件”是因，“动作”和“次态”是果。\n 现态：指当前所处的状态 条件：又称“事件”，当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移 动作：条件满足后执行的动作。动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必须的，当条件满足后，也可以不执行任何动作，直接迁移到新的状态。 次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转换成“现态”。  状态机动作类型：  进入动作：在进入状态时进行 退出动作：在退出状态时进行 输入动作：依赖于当前状态和输入条件进行 转移动作：在进行特定转移时进行  二、spring statemachine spring statemachine是使用 Spring框架下的状态机概念创建的一种应用程序开发框架。它使得状态机结构层次化，简化了配置状态机的过程。\n官方文档：https://docs.spring.io/autorepo/docs/spring-statemachine/1.0.0.M3/reference/htmlsingle/#sm-statecontext\n例子一：简单订单状态 源码已经上传到github。\n如下所示：\n1 引入依赖   org.springframework.statemachine spring-statemachine-core 2.0.1.RELEASE  2 创建订单状态枚举类和状态转换枚举类 /** * 订单状态 * * @author sunbufu */ public enum OrderState { /** 待支付 */ WAIT_PAYMENT, /** 待发货 */ WAIT_DELIVER, /** 待收货 */ WAIT_RECEIVE, /** 完结 */ FINISH; } /** * 订单事件 * * @author sunbufu */ public enum OrderEvent { /** 支付 */ PAYED, /** 发货 */ DELIVERY, /** 收货 */ RECEIVED; } 3 添加配置 /** * 订单状态机配置 * * @author sunbufu */ @Configuration @EnableStateMachine(name = \"orderStateMachine\") public class OrderStateMachineConfig extends EnumStateMachineConfigurerAdapterOrderState, OrderEvent { @Override public void configure(StateMachineStateConfigurerOrderState, OrderEvent states) throws Exception { states.withStates() // 默认状态  .initial(OrderState.WAIT_PAYMENT) // 全部状态  .states(EnumSet.allOf(OrderState.class)); } @Override public void configure(StateMachineTransitionConfigurerOrderState, OrderEvent transitions) throws Exception { transitions.withExternal() // 支付事件 待支付 - 待发货  .source(OrderState.WAIT_PAYMENT).target(OrderState.WAIT_DELIVER).event(OrderEvent.PAYED) // 发货事件 待发货 - 待收货  .and().withExternal().source(OrderState.WAIT_DELIVER).target(OrderState.WAIT_RECEIVE).event(OrderEvent.DELIVERY) // 收货事件 待收货 - 完结  .and().withExternal().source(OrderState.WAIT_RECEIVE).target(OrderState.FINISH).event(OrderEvent.RECEIVED); } /** 状态机持久化 */ @Bean public StateMachinePersisterOrderState, OrderEvent, Order orderStateMachinePersister() { return new DefaultStateMachinePersister(new StateMachinePersistOrderState, OrderEvent, Order() { @Override public void write(StateMachineContextOrderState, OrderEvent context, Order order) { // 进行持久化操作  order.setStatus(context.getState()); } @Override public StateMachineContextOrderState, OrderEvent read(Order order) { // 读取状态并设置到context中  return new DefaultStateMachineContext(order.getStatus(), null, null, null); } }); } } 4 添加订单状态监听器 /** * 订单状态变更监听器 * * @author sunbufu */ @Component @WithStateMachine(name = \"orderStateMachine\") public class OrderStateListener { @OnTransition(source = \"WAIT_PAYMENT\", target = \"WAIT_DELIVER\") public boolean payTransition(MessageOrderEvent message) { System.out.println(\"待支付 --支付-- 待发货\"); return true; } @OnTransition(source = \"WAIT_DELIVER\", target = \"WAIT_RECEIVE\") public boolean deliverTransition(MessageOrderEvent message) { System.out.println(\"待发货 --发货-- 待收货\"); return true; } @OnTransition(source = \"WAIT_RECEIVE\", target = \"FINISH\") public boolean receiveTransition(MessageOrderEvent message) { System.out.println(\"待收货 --收货-- 完成\"); return true; } } 5 service中使用 /** * 订单服务 * * 待支付 - 待发货 - 待收货 - 完结 * * @author sunbufu */ @Service public class OrderServiceImpl implements OrderService { @Autowired private StateMachineOrderState, OrderEvent orderStateMachine; @Autowired private StateMachinePersisterOrderState, OrderEvent, Order orderStateMachinePersister; @Autowired private OrderMapper orderMapper; @Override public Order create() { Order order = new Order(); order.setStatus(OrderState.WAIT_PAYMENT); return orderMapper.save(order); } @Override public Order pay(int id) { Order order = orderMapper.select(id); if (!sendEvent(OrderEvent.PAYED, order)) { throw new RuntimeException(\" 等待支付 - 等待发货 失败, 状态异常 order=\" + order); } return order; } @Override public Order deliver(int id) { Order order = orderMapper.select(id); if (!sendEvent(OrderEvent.DELIVERY, order)) { throw new RuntimeException(\" 等待发货 - 等待收货 失败，状态异常 order=\" + order); } return order; } @Override public Order receive(int id) { Order order = orderMapper.select(id); if (!sendEvent(OrderEvent.RECEIVED, order)) { throw new RuntimeException(\" 等待收货 - 完成 失败，状态异常 order=\" + order); } return order; } /** * 发送订单状态转换事件 * * @param event 事件 * @param order 订单 * @return 执行结果 */ private boolean sendEvent(OrderEvent event, Order order) { boolean result = false; try { orderStateMachine.start(); // 设置状态机状态  orderStateMachinePersister.restore(orderStateMachine, order); result = orderStateMachine.sendEvent(MessageBuilder.withPayload(event).setHeader(\"order\", order).build()); // 保存状态机状态  orderStateMachinePersister.persist(orderStateMachine, order); } catch (Exception e) { e.printStackTrace(); } finally { orderStateMachine.stop(); } return result; } } 6 测试 @RunWith(SpringRunner.class) @SpringBootTest(classes = Application.class) public class OrderServiceImplTest { @Autowired private OrderService orderService; @Test public void testSuccess(){ Order order = orderService.create(); orderService.pay(order.getId()); orderService.deliver(order.getId()); orderService.receive(order.getId()); assertTrue(OrderState.FINISH == order.getStatus()); } @Test(expected = RuntimeException.class) public void testError(){ Order order = orderService.create(); // orderService.pay(order.getId());  orderService.deliver(order.getId()); orderService.receive(order.getId()); assertTrue(OrderState.FINISH == order.getStatus()); } } ","wordCount":"518","inLanguage":"en","datePublished":"2018-06-13T00:00:00Z","dateModified":"2018-06-13T00:00:00Z","author":{"@type":"Person","name":"sunbufu"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://sunbufu.vercel.app/posts/2018-and-before/2018-06-13-spring-statemachine/"},"publisher":{"@type":"Organization","name":"Sunbufu's blog","logo":{"@type":"ImageObject","url":"https://sunbufu.vercel.app/icon/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script><noscript><style type=text/css>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:rgba(255, 255, 255, 0.84);--secondary:rgba(255, 255, 255, 0.56);--tertiary:rgba(255, 255, 255, 0.16);--content:rgba(255, 255, 255, 0.74);--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><header class=header><nav class=nav><div class=logo><a href=https://sunbufu.vercel.app/ accesskey=h title="Sunbufu's blog (Alt + H)">Sunbufu's blog</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://sunbufu.vercel.app/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://sunbufu.vercel.app/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://sunbufu.vercel.app/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://sunbufu.vercel.app/>Home</a>&nbsp;»&nbsp;<a href=https://sunbufu.vercel.app/posts/>Posts</a></div><h1 class=post-title>Spring StateMachine介绍</h1><div class=post-description>Spring StateMachine介绍</div><div class=post-meta>June 13, 2018&nbsp;·&nbsp;3 min&nbsp;·&nbsp;sunbufu</div></header><div class=post-content><h1 id=一状态机>一、状态机<a hidden class=anchor aria-hidden=true href=#一状态机>#</a></h1><p>有限状态机是一种用来进行对象行为建模的工具，其作用主要是描述对象在它的生命周期内所经历的状态序列，以及如何响应来自外界的各种事件。在电商场景（订单、物流、售后）、社交（IM消息投递）、分布式集群管理（分布式计算平台任务编排）等场景都有大规模的使用。</p><h2 id=状态机的要素>状态机的要素：<a hidden class=anchor aria-hidden=true href=#状态机的要素>#</a></h2><p>状态机可归纳为4个要素，现态、条件、动作、次态。“现态”和“条件”是因，“动作”和“次态”是果。</p><ol><li>现态：指当前所处的状态</li><li>条件：又称“事件”，当一个条件被满足，将会触发一个动作，或者执行一次状态的迁移</li><li>动作：条件满足后执行的动作。动作执行完毕后，可以迁移到新的状态，也可以仍旧保持原状态。动作不是必须的，当条件满足后，也可以不执行任何动作，直接迁移到新的状态。</li><li>次态：条件满足后要迁往的新状态。“次态”是相对于“现态”而言的，“次态”一旦被激活，就转换成“现态”。</li></ol><h2 id=状态机动作类型>状态机动作类型：<a hidden class=anchor aria-hidden=true href=#状态机动作类型>#</a></h2><ol><li>进入动作：在进入状态时进行</li><li>退出动作：在退出状态时进行</li><li>输入动作：依赖于当前状态和输入条件进行</li><li>转移动作：在进行特定转移时进行</li></ol><h1 id=二spring-statemachine>二、spring statemachine<a hidden class=anchor aria-hidden=true href=#二spring-statemachine>#</a></h1><p>spring statemachine是使用 Spring框架下的状态机概念创建的一种应用程序开发框架。它使得状态机结构层次化，简化了配置状态机的过程。<br>官方文档：<a href=https://docs.spring.io/autorepo/docs/spring-statemachine/1.0.0.M3/reference/htmlsingle/#sm-statecontext>https://docs.spring.io/autorepo/docs/spring-statemachine/1.0.0.M3/reference/htmlsingle/#sm-statecontext</a></p><h2 id=例子一简单订单状态>例子一：简单订单状态<a hidden class=anchor aria-hidden=true href=#例子一简单订单状态>#</a></h2><p><img loading=lazy src=/posts/2018-and-before/20180507125704883.jpg alt=订单状态流程><br>源码已经上传到<a href=https://github.com/sunbufu/spring-state-machine-demo>github</a>。<br>如下所示：</p><h3 id=1-引入依赖>1 引入依赖<a hidden class=anchor aria-hidden=true href=#1-引入依赖>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:#75715e>&lt;!--spring statemachine--&gt;</span>
<span style=color:#f92672>&lt;dependency&gt;</span>
    <span style=color:#f92672>&lt;groupId&gt;</span>org.springframework.statemachine<span style=color:#f92672>&lt;/groupId&gt;</span>
    <span style=color:#f92672>&lt;artifactId&gt;</span>spring-statemachine-core<span style=color:#f92672>&lt;/artifactId&gt;</span>
    <span style=color:#f92672>&lt;version&gt;</span>2.0.1.RELEASE<span style=color:#f92672>&lt;/version&gt;</span>
<span style=color:#f92672>&lt;/dependency&gt;</span>
</code></pre></div><h3 id=2-创建订单状态枚举类和状态转换枚举类>2 创建订单状态枚举类和状态转换枚举类<a hidden class=anchor aria-hidden=true href=#2-创建订单状态枚举类和状态转换枚举类>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e> * 订单状态
</span><span style=color:#75715e> * 
</span><span style=color:#75715e> * @author sunbufu
</span><span style=color:#75715e> */</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> OrderState <span style=color:#f92672>{</span>
    <span style=color:#75715e>/** 待支付 */</span>
    WAIT_PAYMENT<span style=color:#f92672>,</span>
    <span style=color:#75715e>/** 待发货 */</span>
    WAIT_DELIVER<span style=color:#f92672>,</span>
    <span style=color:#75715e>/** 待收货 */</span>
    WAIT_RECEIVE<span style=color:#f92672>,</span>
    <span style=color:#75715e>/** 完结 */</span>
    FINISH<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e> * 订单事件
</span><span style=color:#75715e> * 
</span><span style=color:#75715e> * @author sunbufu
</span><span style=color:#75715e> */</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>enum</span> OrderEvent <span style=color:#f92672>{</span>
    <span style=color:#75715e>/** 支付 */</span>
    PAYED<span style=color:#f92672>,</span>
    <span style=color:#75715e>/** 发货 */</span>
    DELIVERY<span style=color:#f92672>,</span>
    <span style=color:#75715e>/** 收货 */</span>
    RECEIVED<span style=color:#f92672>;</span>
<span style=color:#f92672>}</span>

</code></pre></div><h3 id=3-添加配置>3 添加配置<a hidden class=anchor aria-hidden=true href=#3-添加配置>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e> * 订单状态机配置
</span><span style=color:#75715e> * 
</span><span style=color:#75715e> * @author sunbufu
</span><span style=color:#75715e> */</span>
<span style=color:#a6e22e>@Configuration</span>
<span style=color:#a6e22e>@EnableStateMachine</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;orderStateMachine&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderStateMachineConfig</span> <span style=color:#66d9ef>extends</span> EnumStateMachineConfigurerAdapter<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>&gt;</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>StateMachineStateConfigurer<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>&gt;</span> states<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        states<span style=color:#f92672>.</span><span style=color:#a6e22e>withStates</span><span style=color:#f92672>()</span>
            <span style=color:#75715e>// 默认状态
</span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>initial</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>WAIT_PAYMENT</span><span style=color:#f92672>)</span>
            <span style=color:#75715e>// 全部状态
</span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>states</span><span style=color:#f92672>(</span>EnumSet<span style=color:#f92672>.</span><span style=color:#a6e22e>allOf</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>));</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>configure</span><span style=color:#f92672>(</span>StateMachineTransitionConfigurer<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>&gt;</span> transitions<span style=color:#f92672>)</span> <span style=color:#66d9ef>throws</span> Exception <span style=color:#f92672>{</span>
        transitions<span style=color:#f92672>.</span><span style=color:#a6e22e>withExternal</span><span style=color:#f92672>()</span>
            <span style=color:#75715e>// 支付事件 待支付 -&gt; 待发货
</span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>source</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>WAIT_PAYMENT</span><span style=color:#f92672>).</span><span style=color:#a6e22e>target</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>WAIT_DELIVER</span><span style=color:#f92672>).</span><span style=color:#a6e22e>event</span><span style=color:#f92672>(</span>OrderEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>PAYED</span><span style=color:#f92672>)</span>
            <span style=color:#75715e>// 发货事件 待发货 -&gt; 待收货
</span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>and</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withExternal</span><span style=color:#f92672>().</span><span style=color:#a6e22e>source</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>WAIT_DELIVER</span><span style=color:#f92672>).</span><span style=color:#a6e22e>target</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>WAIT_RECEIVE</span><span style=color:#f92672>).</span><span style=color:#a6e22e>event</span><span style=color:#f92672>(</span>OrderEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>DELIVERY</span><span style=color:#f92672>)</span>
            <span style=color:#75715e>// 收货事件 待收货 -&gt; 完结
</span><span style=color:#75715e></span>            <span style=color:#f92672>.</span><span style=color:#a6e22e>and</span><span style=color:#f92672>().</span><span style=color:#a6e22e>withExternal</span><span style=color:#f92672>().</span><span style=color:#a6e22e>source</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>WAIT_RECEIVE</span><span style=color:#f92672>).</span><span style=color:#a6e22e>target</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>FINISH</span><span style=color:#f92672>).</span><span style=color:#a6e22e>event</span><span style=color:#f92672>(</span>OrderEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>RECEIVED</span><span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>/** 状态机持久化 */</span>
    <span style=color:#a6e22e>@Bean</span>
    <span style=color:#66d9ef>public</span> StateMachinePersister<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>,</span> Order<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>orderStateMachinePersister</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultStateMachinePersister<span style=color:#f92672>&lt;&gt;(</span><span style=color:#66d9ef>new</span> StateMachinePersist<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>,</span> Order<span style=color:#f92672>&gt;()</span> <span style=color:#f92672>{</span>
            <span style=color:#a6e22e>@Override</span>
            <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>write</span><span style=color:#f92672>(</span>StateMachineContext<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>&gt;</span> context<span style=color:#f92672>,</span> Order order<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#75715e>// 进行持久化操作
</span><span style=color:#75715e></span>                order<span style=color:#f92672>.</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>context<span style=color:#f92672>.</span><span style=color:#a6e22e>getState</span><span style=color:#f92672>());</span>
            <span style=color:#f92672>}</span>

            <span style=color:#a6e22e>@Override</span>
            <span style=color:#66d9ef>public</span> StateMachineContext<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>read</span><span style=color:#f92672>(</span>Order order<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
                <span style=color:#75715e>// 读取状态并设置到context中
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> DefaultStateMachineContext<span style=color:#f92672>&lt;&gt;(</span>order<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>(),</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>,</span> <span style=color:#66d9ef>null</span><span style=color:#f92672>);</span>
            <span style=color:#f92672>}</span>
        <span style=color:#f92672>});</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=4-添加订单状态监听器>4 添加订单状态监听器<a hidden class=anchor aria-hidden=true href=#4-添加订单状态监听器>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e> * 订单状态变更监听器
</span><span style=color:#75715e> * 
</span><span style=color:#75715e> * @author sunbufu
</span><span style=color:#75715e> */</span>
<span style=color:#a6e22e>@Component</span>
<span style=color:#a6e22e>@WithStateMachine</span><span style=color:#f92672>(</span>name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;orderStateMachine&#34;</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderStateListener</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@OnTransition</span><span style=color:#f92672>(</span>source <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WAIT_PAYMENT&#34;</span><span style=color:#f92672>,</span> target <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WAIT_DELIVER&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>payTransition</span><span style=color:#f92672>(</span>Message<span style=color:#f92672>&lt;</span>OrderEvent<span style=color:#f92672>&gt;</span> message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;待支付 --支付--&gt; 待发货&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@OnTransition</span><span style=color:#f92672>(</span>source <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WAIT_DELIVER&#34;</span><span style=color:#f92672>,</span> target <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WAIT_RECEIVE&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>deliverTransition</span><span style=color:#f92672>(</span>Message<span style=color:#f92672>&lt;</span>OrderEvent<span style=color:#f92672>&gt;</span> message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;待发货 --发货--&gt; 待收货&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@OnTransition</span><span style=color:#f92672>(</span>source <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;WAIT_RECEIVE&#34;</span><span style=color:#f92672>,</span> target <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;FINISH&#34;</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>receiveTransition</span><span style=color:#f92672>(</span>Message<span style=color:#f92672>&lt;</span>OrderEvent<span style=color:#f92672>&gt;</span> message<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        System<span style=color:#f92672>.</span><span style=color:#a6e22e>out</span><span style=color:#f92672>.</span><span style=color:#a6e22e>println</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;待收货 --收货--&gt; 完成&#34;</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>true</span><span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=5-service中使用>5 service中使用<a hidden class=anchor aria-hidden=true href=#5-service中使用>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>/**
</span><span style=color:#75715e> * 订单服务
</span><span style=color:#75715e> *
</span><span style=color:#75715e> * 待支付 -&gt; 待发货 -&gt; 待收货 -&gt; 完结
</span><span style=color:#75715e> *
</span><span style=color:#75715e> * @author sunbufu
</span><span style=color:#75715e> */</span>
<span style=color:#a6e22e>@Service</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderServiceImpl</span> <span style=color:#66d9ef>implements</span> OrderService <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> StateMachine<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>&gt;</span> orderStateMachine<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> StateMachinePersister<span style=color:#f92672>&lt;</span>OrderState<span style=color:#f92672>,</span> OrderEvent<span style=color:#f92672>,</span> Order<span style=color:#f92672>&gt;</span> orderStateMachinePersister<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> OrderMapper orderMapper<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>create</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
        Order order <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Order<span style=color:#f92672>();</span>
        order<span style=color:#f92672>.</span><span style=color:#a6e22e>setStatus</span><span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>WAIT_PAYMENT</span><span style=color:#f92672>);</span>
        <span style=color:#66d9ef>return</span> orderMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>save</span><span style=color:#f92672>(</span>order<span style=color:#f92672>);</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>pay</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Order order <span style=color:#f92672>=</span> orderMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>sendEvent<span style=color:#f92672>(</span>OrderEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>PAYED</span><span style=color:#f92672>,</span> order<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34; 等待支付 -&gt; 等待发货 失败, 状态异常 order=&#34;</span> <span style=color:#f92672>+</span> order<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> order<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>deliver</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Order order <span style=color:#f92672>=</span> orderMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>sendEvent<span style=color:#f92672>(</span>OrderEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>DELIVERY</span><span style=color:#f92672>,</span> order<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34; 等待发货 -&gt; 等待收货 失败，状态异常 order=&#34;</span> <span style=color:#f92672>+</span> order<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> order<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Override</span>
    <span style=color:#66d9ef>public</span> Order <span style=color:#a6e22e>receive</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> id<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        Order order <span style=color:#f92672>=</span> orderMapper<span style=color:#f92672>.</span><span style=color:#a6e22e>select</span><span style=color:#f92672>(</span>id<span style=color:#f92672>);</span>
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>(!</span>sendEvent<span style=color:#f92672>(</span>OrderEvent<span style=color:#f92672>.</span><span style=color:#a6e22e>RECEIVED</span><span style=color:#f92672>,</span> order<span style=color:#f92672>))</span> <span style=color:#f92672>{</span>
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> RuntimeException<span style=color:#f92672>(</span><span style=color:#e6db74>&#34; 等待收货 -&gt; 完成 失败，状态异常 order=&#34;</span> <span style=color:#f92672>+</span> order<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> order<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>

    <span style=color:#75715e>/**
</span><span style=color:#75715e>     * 发送订单状态转换事件
</span><span style=color:#75715e>     *
</span><span style=color:#75715e>     * @param event 事件
</span><span style=color:#75715e>     * @param order 订单
</span><span style=color:#75715e>     * @return 执行结果
</span><span style=color:#75715e>     */</span>
    <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>boolean</span> <span style=color:#a6e22e>sendEvent</span><span style=color:#f92672>(</span>OrderEvent event<span style=color:#f92672>,</span> Order order<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
        <span style=color:#66d9ef>boolean</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span><span style=color:#f92672>;</span>
        <span style=color:#66d9ef>try</span> <span style=color:#f92672>{</span>
            orderStateMachine<span style=color:#f92672>.</span><span style=color:#a6e22e>start</span><span style=color:#f92672>();</span>
            <span style=color:#75715e>// 设置状态机状态
</span><span style=color:#75715e></span>            orderStateMachinePersister<span style=color:#f92672>.</span><span style=color:#a6e22e>restore</span><span style=color:#f92672>(</span>orderStateMachine<span style=color:#f92672>,</span> order<span style=color:#f92672>);</span>
            result <span style=color:#f92672>=</span> orderStateMachine<span style=color:#f92672>.</span><span style=color:#a6e22e>sendEvent</span><span style=color:#f92672>(</span>MessageBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>withPayload</span><span style=color:#f92672>(</span>event<span style=color:#f92672>).</span><span style=color:#a6e22e>setHeader</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;order&#34;</span><span style=color:#f92672>,</span> order<span style=color:#f92672>).</span><span style=color:#a6e22e>build</span><span style=color:#f92672>());</span>
            <span style=color:#75715e>// 保存状态机状态
</span><span style=color:#75715e></span>            orderStateMachinePersister<span style=color:#f92672>.</span><span style=color:#a6e22e>persist</span><span style=color:#f92672>(</span>orderStateMachine<span style=color:#f92672>,</span> order<span style=color:#f92672>);</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>catch</span> <span style=color:#f92672>(</span>Exception e<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
            e<span style=color:#f92672>.</span><span style=color:#a6e22e>printStackTrace</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span> <span style=color:#66d9ef>finally</span> <span style=color:#f92672>{</span>
            orderStateMachine<span style=color:#f92672>.</span><span style=color:#a6e22e>stop</span><span style=color:#f92672>();</span>
        <span style=color:#f92672>}</span>
        <span style=color:#66d9ef>return</span> result<span style=color:#f92672>;</span>
    <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h3 id=6-测试>6 测试<a hidden class=anchor aria-hidden=true href=#6-测试>#</a></h3><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#a6e22e>@RunWith</span><span style=color:#f92672>(</span>SpringRunner<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style=color:#a6e22e>@SpringBootTest</span><span style=color:#f92672>(</span>classes <span style=color:#f92672>=</span> Application<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
<span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>OrderServiceImplTest</span> <span style=color:#f92672>{</span>

    <span style=color:#a6e22e>@Autowired</span>
    <span style=color:#66d9ef>private</span> OrderService orderService<span style=color:#f92672>;</span>

    <span style=color:#a6e22e>@Test</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testSuccess</span><span style=color:#f92672>(){</span>
        Order order <span style=color:#f92672>=</span> orderService<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>();</span>
        orderService<span style=color:#f92672>.</span><span style=color:#a6e22e>pay</span><span style=color:#f92672>(</span>order<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
        orderService<span style=color:#f92672>.</span><span style=color:#a6e22e>deliver</span><span style=color:#f92672>(</span>order<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
        orderService<span style=color:#f92672>.</span><span style=color:#a6e22e>receive</span><span style=color:#f92672>(</span>order<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
        assertTrue<span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>FINISH</span> <span style=color:#f92672>==</span> order<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>

    <span style=color:#a6e22e>@Test</span><span style=color:#f92672>(</span>expected <span style=color:#f92672>=</span> RuntimeException<span style=color:#f92672>.</span><span style=color:#a6e22e>class</span><span style=color:#f92672>)</span>
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>testError</span><span style=color:#f92672>(){</span>
        Order order <span style=color:#f92672>=</span> orderService<span style=color:#f92672>.</span><span style=color:#a6e22e>create</span><span style=color:#f92672>();</span>
<span style=color:#75715e>//        orderService.pay(order.getId());
</span><span style=color:#75715e></span>        orderService<span style=color:#f92672>.</span><span style=color:#a6e22e>deliver</span><span style=color:#f92672>(</span>order<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
        orderService<span style=color:#f92672>.</span><span style=color:#a6e22e>receive</span><span style=color:#f92672>(</span>order<span style=color:#f92672>.</span><span style=color:#a6e22e>getId</span><span style=color:#f92672>());</span>
        assertTrue<span style=color:#f92672>(</span>OrderState<span style=color:#f92672>.</span><span style=color:#a6e22e>FINISH</span> <span style=color:#f92672>==</span> order<span style=color:#f92672>.</span><span style=color:#a6e22e>getStatus</span><span style=color:#f92672>());</span>
    <span style=color:#f92672>}</span>

<span style=color:#f92672>}</span>
</code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://sunbufu.vercel.app/tags/java/>java</a></li><li><a href=https://sunbufu.vercel.app/tags/spring/>spring</a></li></ul><nav class=paginav><a class=prev href=https://sunbufu.vercel.app/posts/2018-and-before/2018-06-13-springcloud-inner-safe/><span class=title>« Prev Page</span><br><span>Spring Cloud 保证微服务内安全</span></a>
<a class=next href=https://sunbufu.vercel.app/posts/2018-and-before/2018-06-13-unit-test/><span class=title>Next Page »</span><br><span>单元测试</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2021 <a href=https://sunbufu.vercel.app/>Sunbufu's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)"><button class=top-link id=top-link type=button accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></button></a>
<script>let menu=document.getElementById('menu');menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)},document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script></body></html>